#! /bin/bash

set -e

ROOT="${BASH_SOURCE[0]}";
if([ -h "${ROOT}" ]) then
  while([ -h "${ROOT}" ]) do ROOT=`readlink "${ROOT}"`; done
fi
ROOT=$(cd `dirname "${ROOT}"` && cd .. && pwd) # Up one level

SUBPROJECT="${1}"

if [ -z "${SUBPROJECT}" ]; then
  echo "Usage: ${0} <subproject>" >&2
  exit 1
fi

CURRENT_SCHEMA_VERSION="$(${ROOT}/bin/current-schema-version ${ROOT}/schema/${SUBPROJECT}/lang/)"

TEMPLATE_DATA_HANDLER="${ROOT}/schema/api/client_api.template/data_tool.template.lua"
DATA_HANDLER="${ROOT}/schema/api/client_api/handlers/data/${SUBPROJECT}.lua"

echo "--> Generating data-tool url handlers..."
pk-fill-placeholders \
  "${TEMPLATE_DATA_HANDLER}" \
  <(echo -n "SUBPROJECT='${SUBPROJECT}'; \
    CURRENT_SCHEMA_VERSION='${CURRENT_SCHEMA_VERSION}'") \
  "${DATA_HANDLER}"
