#! /bin/bash

set -e

ROOT="${BASH_SOURCE[0]}";
if([ -h "${ROOT}" ]) then
  while([ -h "${ROOT}" ]) do ROOT=`readlink "${ROOT}"`; done
fi
ROOT=$(cd `dirname "${ROOT}"` && cd .. && pwd) # Up one level

SUBPROJECT="${1}"

if [ -z "${SUBPROJECT}" ]; then
  echo "Usage: ${0} <subproject> <schema-tool-command>" >&2
  exit 1
fi
shift

NAME="pk-logiceditor.schema-tool"

MODULE="${NAME}.run"
ROCK="${NAME}"
PRIVATE_MODULES_PATH="$(luarocks show --rock-dir ${ROCK})/src/lua/?.lua"

TEMPLATE_CONFIG="${ROOT}/project-config/schema-tool/config.template.lua"
BASE_CONFIG="${ROOT}/project-config/schema-tool/${SUBPROJECT}.lua"

#echo "--> Generating schema-tool config..."
pk-fill-placeholders \
  "${TEMPLATE_CONFIG}" \
  <(echo -n "SUBPROJECT='${SUBPROJECT}'") \
  "${BASE_CONFIG}"

pk-call-lua-module \
  "${PRIVATE_MODULES_PATH}" \
  "${MODULE}" \
  "run" \
  "${ROOT}/" \
  --base-config=${BASE_CONFIG} \
  "$@"
