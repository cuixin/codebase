#! /usr/bin/env pk-lua-interpreter

--------------------------------------------------------------------------------
-- pk-call-lua-module: run arbitrary function from Lua module in pk environment
--------------------------------------------------------------------------------

pcall(require, 'luarocks.require') -- Ignoring errors

--------------------------------------------------------------------------------

-- pk-engine
require 'copas' -- Should be loaded first
require 'posix'
require 'socket'
require 'socket.http'
require 'luabins'
require 'socket.url'
require 'md5'
require 'luasql.mysql'
require 'uuid'
require 'lfs'
require 'ev'
require 'ltn12'
require 'random'
require 'sidereal'

--------------------------------------------------------------------------------

-- pk-tools
if jit == nil then
  -- NOTE: This actually is used in apigen only,
  --       all other tools are LJ2-compatible.
  require 'inspector' -- Actually that's lbci
else
  require 'jit.util'
  require 'jit.vmdef'
  require 'bit' -- Builtin to LJ2
end

--------------------------------------------------------------------------------

require 'lua-nucleo.module'
require 'lua-nucleo.strict'
require 'pk-core.module'

--------------------------------------------------------------------------------

import 'pk-core/common_logging.lua' { 'create_common_stdout_logging' } ()

--------------------------------------------------------------------------------

local extra_path = assert(select(1, ...), "missing extra_path")
local module_name = assert(select(2, ...), "missing module_name")
local function_name = assert(select(3, ...), "missing function_name")

if extra_path ~= "" then
  if extra_path:sub(#extra_path) ~= ";" then
    extra_path = extra_path .. ";"
  end

  if package.path:sub(#package.path) ~= ";" then
    package.path = package.path .. ";"
  end

  package.path = package.path .. extra_path
end

local module = require(module_name)
assert(
    module[function_name],
    "module does not export specified function"
  )(select(4, ...))
